<html
        xmlns:f="http://typo3.org/ns/TYPO3/CMS/Fluid/ViewHelpers"
        xmlns:ieb="http://typo3.org/ns/GeorgRinger/Ieb/ViewHelpers"
        data-namespace-typo3-fluid="true">
<f:layout name="Default"/>

<f:section name="content">
    <h1>ARCHIV</h1>


    <f:form method="get" action="index" name="filter" object="{filter}">
        <f:form.hidden property="submitted" value="1"/>
        
        <f:if condition="{userIsPartOfGs}"></f:if>
        <div class="row archivfilter" >
            <div class="col-4">
                <label for="trPid">
                    Träger<br>
                    <f:form.select property="trPid" id="trPid" class="filter3" options="{options.tr}" prependOptionValue="-1" prependOptionLabel=""/>
                </label>
            </div>
            <div class="col-4">
                <label for="status">
                    Status<br>
                    <f:form.select property="status" id="status"  class="filter3" options="{options.status}" prependOptionValue="-1" prependOptionLabel=""/>
                </label>
            </div>
            <div class="col-2">
                <label for="ansuchenNummer">
                    Bundesland<br>
                    <f:form.select property="bundesland" id="bundesland"  class="filter3" options="{options.bundesland}" prependOptionValue="-1" prependOptionLabel=""/>
                </label>
            </div>
            <div class="col-2">
                <label for="ansuchenNummer">
                    Ansuchennummer<br>
                    <f:form.textfield property="ansuchenNummer"  class="filter" id="ansuchenNummer" />
                </label>
            </div>
        </div>
        <div class="row archivfilter">
            <div class="col-6">
                <label for="searchText">
                    Suchen im Ansuchen
                    <f:form.textfield property="search"  class="filter" id="searchText" />
                </label>
            </div>
            <div class="col-6">
                <label for="searchTextStammdaten">
                    Suchen in den Organisationsdaten
                    <f:form.textfield property="searchStammdaten"  class="filter" id="searchTextStammdaten" />
                </label>
            </div>
        </div>
        <f:form.submit class="knopf-s" value="Anzeigen"/> <div class="knopf-s knopfersatz" id="zuruecksetzen">Filter zurücksetzen</div>

    </f:form>
    <div class="abstand-gross"></div>



    <f:if condition="{filter.submitted}">
        <f:if condition="{items}">
            
            <f:then>
                <table>
                    <tbody>
                    <f:for each="{pagination.paginator.paginatedItems}" as="item">
                        {item.copyStammdatenData -> f:variable(name: 'stammdaten')}
                        

                        <div class="ansuchenlistenitem" data-date="{item.uid}" data-name="{item.name}" data-nummer="{item.nummer}" data-status="{item.status}" data-pid="{item.pid}" >
                            <table class="ansuchenliste archiv">
                                <tr>
                                    <td colspan="5" class="ansuchenliste_tr">
                                        <f:if condition="{item.stammdatenMarkenname}">
                                            <f:then>
                                                <span class="fett">{item.stammdatenMarkenname}</span> &nbsp;&nbsp;{item.stammdatenName}
                                            </f:then>
                                            <f:else>
                                                <span class="fett">{item.stammdatenName}</span>
                                            </f:else>
                                            
                                        </f:if>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="ansuchenliste_ansuchennr">
                                        {item.nummer}
                                        
                                    </td>
                                    <td class="ansuchenliste_bezeichnung">
                                        <span class="ansuchenliste_ansuchenname">{item.name}</span> {f:if(condition:'{item.pruefbescheid_check}==1', then:'<span class="knopfrund pruefbescheid titleview" title="mit Prüfbescheid"></span>')}<br>
                                        <f:if condition="{item.akkreditierung_datum}">
                                            <f:then>
                                                <f:translate key="ansuchen.status.{item.status}" /> (<f:format.date format='d.m.Y'>{item.akkreditierung_datum}</f:format.date>)
                                            </f:then>
                                            <f:else>
                                                <f:translate key="ansuchen.status.{item.status}" /> (<f:format.date format='d.m.Y'>{item.akkreditierung_entscheidung_datum}</f:format.date>)
                                            </f:else>
                                        </f:if>
                                        <code>uid: {item.uid} status:{item.status} incoming:{item.review_incoming_status} version:{item.version+1}</code>
                                    </td>

                                    <td class="td-knopf">
                                        <f:if condition="{item.akkreditierungPdf}">
                                                        <f:then>
                                                            <ieb:falFromRecord field="akkreditierung_pdf" id="{item.uid}" table="tx_ieb_domain_model_ansuchen" as="falItems">
                                                                <f:if condition="{falItems.0}">
                                                                    <a href="{falItems.0.publicUrl}" class="knopf-quadratisch zertifikat" target="_blank" title="Akkreditierungs-Zertifikat als PDF" >&#8288;</a>
                                                                </f:if>
                                                            </ieb:falFromRecord>
                                                        </f:then>
                                                        <f:else>
                                                            <ieb:falFromRecord field="akkreditierung_pdf" id="{item.lastuid}" table="tx_ieb_domain_model_ansuchen" as="falItems">
                                                                <f:if condition="{falItems.0}">
                                                                    <a href="{falItems.0.publicUrl}" class="knopf-quadratisch zertifikat" target="_blank" title="Akkreditierungs-Zertifikat als PDF" >&#8288;</a>
                                                                </f:if>
                                                            </ieb:falFromRecord>
                                                        </f:else>
                                         </f:if>
                                    </td>
                                    <td class="td-knopf">
                                        <f:if condition="{item.pp3} && {item.version}==0">
                                            <f:then>
                                                
                                                <f:link.action action="show" pageUid="21" target="_blank" controller="Ansuchen" arguments="{ansuchen : item.uid}" class="knopf-quadratisch show" title="Ansuchen zeigen (Version {ansuchen.version+1})"></f:link.action>
                                                <td class="td-knopf"><span class="titleview knopfrund achtung-gelb " title="Das Ansuchen aus der PP3 liegt erst in der ersten Version vor. Möglicherweise sind die Daten also unvollständig."></span></td>
                                            </f:then>

                                            <f:else>
                                                

                                                <f:link.action action="show" pageUid="21" target="_blank" controller="Ansuchen" arguments="{ansuchen : item.uid}" class="knopf-quadratisch show" title="Ansuchen zeigen (Version {item.version +1})"></f:link.action>
                                                <td class="td-knopf"></td>
                                            </f:else>
                                        </f:if>
                                        
                                    </td>
                                </tr>
                                <!-- ALTE DARSTELLUNG DER VORVERSIONNEN: -->


<tr>
    <td class="archiv-vorversionen-td" colspan="4">
    <ieb:ansuchenOldVersionLoader nummer="{item.nummer}" as="oldVersions">
        <f:if condition="{oldVersions}">
            <details>
                <summary><span class="">Vorversionen ({oldVersions -> f:count()})</span></summary>
                
                    <f:for each="{oldVersions}" as="oldVersion" iteration="i">
                        <table class="archiv-vorversionen" id="vorv-<f:format.raw>{item.nummer}</f:format.raw>">
                            <tr data-status="{oldversion.version}" class="sort">
                                <td><b>{oldVersion.version +1}</b> [{oldVersion.uid}]</td>
                                
                                <td colspan="3">
                                
                                    <table class="debug">
                                        <tr class="debug-head"><td>status</td><td>incoming status</td><td>tstamp</td><td>crdate</td><td>akkreditierung_datum</td><td>einreich_datum</td><td>zuteilung_datum</td><td>akk-entsch_datum</td></tr>
                                        <tr><td>{oldVersion.status}</td><td>{oldVersion.review_incoming_status}</td><td><f:format.date format='d.m.Y H:i:s'>{oldVersion.tstamp}</f:format.date></td><td><f:format.date format='d.m.Y H:i:s'>{oldVersion.crdate}</f:format.date></td><td><f:format.date format='d.m.Y H:i:s'>{oldVersion.akkreditierung_datum}</f:format.date></td><td><f:format.date format='d.m.Y H:i:s'>{oldVersion.einreich_datum}</f:format.date></td><td><f:format.date format='d.m.Y H:i:s'>{oldVersion.zuteilung_datum}</f:format.date></td><td><f:format.date format='d.m.Y H:i:s'>{oldVersion.akkreditierung_entscheidung_datum}</f:format.date></td></tr>
                                    </table>
                                    
                                    
                                </td>
                                <td class="td-knopf">
                                    <f:if condition="{i.index}==0"> 
                                        <f:then>
                                            <ieb:falFromRecord field="akkreditierung_pdf" id="{item.lastuid}" table="tx_ieb_domain_model_ansuchen" as="falItems">
                                            <f:if condition="{falItems.0}">
                                                <a href="{falItems.0.publicUrl}" class="knopf-quadratisch zertifikat" target="_blank" title="Akkreditierungs-Zertifikat als PDF" >&#8288;</a>
                                            </f:if>
                                        </ieb:falFromRecord>
                                        </f:then>
                                        <f:else>
                                            <ieb:falFromRecord field="akkreditierung_pdf" id="{iplusuid}" table="tx_ieb_domain_model_ansuchen" as="falItems">
                                            <f:if condition="{falItems.0}">
                                                <a href="{falItems.0.publicUrl}" class="knopf-quadratisch zertifikat" target="_blank" title="Akkreditierungs-Zertifikat als PDF" >&#8288;</a>
                                            </f:if>
                                        </ieb:falFromRecord>
                                        </f:else>
                                    </f:if>
                                        
 
                                </td>
                                <td class="td-knopf"><f:link.action action="show" pageUid="21" target="_blank"  controller="Ansuchen" arguments="{ansuchen : oldVersion.uid}" class="knopf-quadratisch show" title="Ansuchen zeigen (Version {oldVersion.version+1})"></f:link.action></td>
                            </tr>
                        </table>
                        <f:variable name="iplusuid">{oldVersion.uid}</f:variable> 
                        
                    </f:for>
                
            </details>
        </f:if>
    </ieb:ansuchenOldVersionLoader>
    </td>
 </tr>

                                <!-- #################### HISTORIE ################ -->
                                <tr class="historie">
                                    <td colspan="4">
                                        <ieb:ansuchenOldVersionLoader nummer="{item.nummer}" as="oldVersions">
                                        <f:if condition="{oldVersions}">
                                            <details>
                                                <summary><span class="">Historie</span> ({oldVersions -> f:count()} Versionen)</summary>
                                                <table id="historytable-{item.nummer}" class="historytable">
                                                    <f:for each="{oldVersions}" as="version" iteration="i"> 
                                                        

                                                    <!-- empty var -->
                                                    <f:variable name="akkreditierungEntscheidungDatum"></f:variable>
                                                    <f:variable name="akkEntschOrig"></f:variable>
                                                    <f:variable name="EinreichDatum"></f:variable>
                                                    <f:variable name="EinreichDatum2"></f:variable>
                                                    <f:variable name="EinreichDatumOrig"></f:variable>

                                                    <!-- KORR DATE 0000000000000000000000000 -->
                                                    <f:if condition="<f:format.date format='d.m.Y'>{version.akkreditierung_entscheidung_datum}</f:format.date> == <f:format.date format='d.m.Y'>{version.tstamp}</f:format.date>">
                                                        <f:then>
                                                            <f:variable name="akkreditierungEntscheidungDatum">{version.akkreditierung_entscheidung_datum}</f:variable>
                                                            <f:variable name="akkEntschOrig"></f:variable>
                                                        </f:then>
                                                        <f:else>
                                                            <f:variable name="akkreditierungEntscheidungDatum">{version.tstamp}</f:variable>
                                                            <f:if condition="!{version.akkreditierung_entscheidung_datum}">
                                                                <f:then>
                                                                    <f:variable name="akkEntschOrig">LEER</f:variable>
                                                                </f:then>
                                                                <f:else>
                                                                    <f:variable name="akkEntschOrig"><f:format.date format='d.m.Y'>{version.akkreditierung_entscheidung_datum}</f:format.date></f:variable>
                                                                </f:else>
                                                            </f:if>
                                                            
                                                        </f:else>
                                                        
                                                    </f:if>
                                                    <f:if condition="<f:format.date format='U'>{version.einreich_datum}</f:format.date> > <f:format.date format='U'>{version.tstamp}</f:format.date>">
                                                        <f:then>
                                                            <f:variable name="EinreichDatum">{version.tstamp}</f:variable>
                                                            <f:variable name="EinreichDatum2">{EinreichDatum - 20}</f:variable>
                                                            <f:variable name="EinreichDatumOrig"><f:format.date format='d.m.Y H:i:s'>{version.einreich_datum}</f:format.date></f:variable>
                                                        </f:then>
                                                        <f:else>
                                                            <f:variable name="EinreichDatum2">{version.einreich_datum}</f:variable>
                                                        </f:else>
                                                    </f:if>

                                                    <!-- KORR st -->
                                                      <f:if condition="{version.status} == 85 || {version.status} == 30 || {version.status} == 230 || {version.status} == 160 || {version.status} == 150 || {version.status} == 155">
                                                        <f:then>
                                                            <span class="titleview klein person-statuskugel status-4" title="DATENKORREKTUR: Falsche Versionen mit ungültigem Status aus dem Dezember 2023 werden ausgeblendet"></span>&nbsp;
                                                        </f:then>
                                                        <f:else>
                                                        <f:if condition="{version.einreich_datum}">
                                                                <tr data-datum="<f:format.date format='U'>{version.einreich_datum}</f:format.date>"  data-version="{version.version}<f:format.date format='U'>{EinreichDatum2}</f:format.date><f:format.printf arguments='{1: version.status}'>%03d</f:format.printf>" class="version-start">
                                                                <td>
                                                                    <f:format.date format='d.m.Y'>{EinreichDatum2}</f:format.date> 
                                                                    <f:if condition="{EinreichDatumOrig}">&nbsp; <span class="titleview klein person-statuskugel status-4" title="DATENKORREKTUR: ursprüngliches Einreich-Datum: {EinreichDatumOrig} geändert auf <f:format.date format='d.m.Y H:i:s'>{EinreichDatum2}</f:format.date>"></span></f:if>
                                                                
                                                                    <code>uid: {version.uid} {version.nummer} | A</code>
                                                                </td>
                                                                <td>
                                                                    {version.version + 1} 
                                                                </td>
                                                                <td>
                                                                    <f:if condition="{version.version}==0 &&  !{version.pp3}">
                                                                        <f:then>
                                                                            Ersteinreichung 
                                                                        </f:then>
                                                                        <f:else>
                                                                            Einreichung  
                                                                        </f:else>
                                                                    </f:if>
                                                                </td>
                                                                <td></td>
                                                                <td></td>
                                                                </tr>
                                                        </f:if>
                                                            
                                                        <f:if condition="{akkreditierungEntscheidungDatum} && ({version.status}==80 || {version.status}==100 || {version.status}==200 || {version.status}==140 || {version.status}==220)">
                                                                <tr data-datum="<f:format.date format='U'>{version.akkreditierung_entscheidung_datum}</f:format.date>"  data-version="{version.version}<f:format.date format='U'>{akkreditierungEntscheidungDatum}</f:format.date><f:format.printf arguments='{1: version.status}'>%03d</f:format.printf>" class="akzent">
                                                                <td>
                                                                    <f:format.date format='d.m.Y'>{akkreditierungEntscheidungDatum}</f:format.date> <f:if condition="{akkEntschOrig}">
                                                                        &nbsp; <span class="titleview klein person-statuskugel status-4" title="DATENKORREKTUR: ursprüngliches Datum der Akkreditierungsentscheidung: {akkEntschOrig}"></span>
                                                                    </f:if>
                                                                    <code>uid: {version.uid} {version.nummer} | B</code>
                                                                </td>
                                                                <td> 
                                                                    {version.version + 1}
                                                                </td>
                                                                <td>
                                                                    Ansuchen ausgeschickt: <f:translate key="ansuchen.status.{version.status}" default="Status {version.status} unbekannt" /> 
                                                                    
                                                                </td>
                                                                <td class="td-knopf">
                                                                    <f:if condition="{version.status}==100 || {version.status}==140">

                                                                    
                                                                        <f:if condition="({i.index}==0)"> 
                                                                            <f:then>
                                                                                <ieb:falFromRecord field="akkreditierung_pdf" id="{item.lastuid}" table="tx_ieb_domain_model_ansuchen" as="falItems">
                                                                                <f:if condition="{falItems.0}">
                                                                                    <a href="{falItems.0.publicUrl}" class="knopf-quadratisch zertifikat" target="_blank" title="Akkreditierungs-Zertifikat als PDF" >&#8288;</a>
                                                                                </f:if>
                                                                            </ieb:falFromRecord>
                                                                            </f:then>
                                                                            <f:else>
                                                                                <ieb:falFromRecord field="akkreditierung_pdf" id="{iplusuid}" table="tx_ieb_domain_model_ansuchen" as="falItems">
                                                                                <f:if condition="{falItems.0}">
                                                                                    <a href="{falItems.0.publicUrl}" class="knopf-quadratisch zertifikat" target="_blank" title="Akkreditierungs-Zertifikat als PDF" >&#8288;</a>
                                                                                </f:if>
                                                                            </ieb:falFromRecord>
                                                                            </f:else>
                                                                        </f:if>

                                                                    </f:if>
                                                                </td>
                                                                <td class="td-knopf"> <f:link.action action="show" pageUid="21" target="_blank"  controller="Ansuchen" arguments="{ansuchen : version.uid}" class="knopf-quadratisch show" title="Ansuchen zeigen (Version {version.version+1})"></f:link.action></td>
                                                                </tr>
                                                        </f:if>
                                                        
                                                        <f:if condition="{version.zuteilung_datum}">
                                                                <tr data-datum="<f:format.date format='U'>{version.zuteilung_datum}</f:format.date>"  data-version="{version.version}<f:format.date format='U'>{version.zuteilung_datum}</f:format.date><f:format.printf arguments='{1: version.status}'>%03d</f:format.printf>">
                                                                <td>
                                                                    <f:format.date format='d.m.Y'>{version.zuteilung_datum}</f:format.date>
                                                                    <code>uid: {version.uid} | C</code>
                                                                </td>
                                                                <td>
                                                                    <f:if condition="">
                                                                        <f:then>

                                                                        </f:then>
                                                                        <f:else>

                                                                        </f:else>
                                                                    </f:if>
                                                                    {version.version + 1}
                                                                </td>
                                                                <td>
                                                                    Zuteilung an <ieb:feuserName uid="{version.gutachter1}" /> {f:if(condition:'{version.gutachter1}&&{version.gutachter2}>0', then:' und ')} <ieb:feuserName uid="{version.gutachter2}" />
                                                                </td>
                                                                <td></td>
                                                                <td></td>
                                                                </tr>
                                                        </f:if>
                                                            <f:variable name="iplusuid">{version.uid}</f:variable>
                                                            <f:variable name="akkEntschOrig"></f:variable>
                                                            <f:variable name="EinreichDatumOrig2"></f:variable>
                                                        </f:else>
                                                      </f:if>
                                                      
                                                    </f:for>
                                                </table>
                                                
                                                <script>
                                                    $(document).ready(function() {
                                                       $('#historytable-<f:format.raw>{item.nummer}</f:format.raw> tr').sort(function(a, b) {
                                                          return $(a).data('version') > $(b).data('version') ? 1 : -1;
                                                       }).appendTo('#historytable-<f:format.raw>{item.nummer}</f:format.raw>');
                                                       $('#vorv-<f:format.raw>{item.nummer}</f:format.raw> tr.sort').sort(function(a, b) {
                                                          return $(a).data('status') > $(b).data('status') ? 1 : -1;
                                                       }).appendTo('#vorv-<f:format.raw>{item.nummer}</f:format.raw>');
                                                    });
                                                 </script>
                                                
                                            </details>
                                        </f:if>
                                    </ieb:ansuchenOldVersionLoader>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </f:for>
                <f:render partial="Pagination" arguments="{pagination: pagination.pagination, pages: pagination.pages, paginator: pagination.paginator}" />
            </f:then>
            <f:else>
                <div>Keine Ansuchen passen auf die Filter</div>
            </f:else>
        </f:if>
    </f:if>
</f:section>

</html>